# encoding: utf-8

# usage: manifest.rb dump.csv

require 'csv'
require 'time'

# Read CSV dump and group records by station
# station: field 3
# name: field 6
# card number: field 16
dump = {}
CSV.foreach(ARGV[0], :headers => true, :encoding => "utf-8") do |row|
  station = row[2].sub(' ','')
  if dump[station] == nil
    dump[station] = []
  end
  dump[station].push([row[5], row[15]])
end

# Get date of delivery to stations (ISO 8601 format, 1 day after delivery to
# station R20), e.g., manifest creation on day 1 -> delivery to R20 on day 2 ->
# delivery to stations on day 3

delivery_date = (Time.now + (60 * 24 * 24 * 2)).strftime("%F")

#####

# mkdir and cd
filedir = File.join(Dir.home, "Desktop", delivery_date)
Dir.mkdir(filedir, 0700)
templatedir = File.join(Dir.home, "Desktop", delivery_date, "template")
Dir.mkdir(templatedir, 0700)
Dir.chdir(filedir)

p1 = '<?xml version="1.0" encoding="UTF-8"?><office:document-content xmlns:office="urn:oasis:names:tc:opendocument:xmlns:office:1.0" xmlns:style="urn:oasis:names:tc:opendocument:xmlns:style:1.0" xmlns:text="urn:oasis:names:tc:opendocument:xmlns:text:1.0" xmlns:table="urn:oasis:names:tc:opendocument:xmlns:table:1.0" xmlns:draw="urn:oasis:names:tc:opendocument:xmlns:drawing:1.0" xmlns:fo="urn:oasis:names:tc:opendocument:xmlns:xsl-fo-compatible:1.0" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:meta="urn:oasis:names:tc:opendocument:xmlns:meta:1.0" xmlns:number="urn:oasis:names:tc:opendocument:xmlns:datastyle:1.0" xmlns:presentation="urn:oasis:names:tc:opendocument:xmlns:presentation:1.0" xmlns:svg="urn:oasis:names:tc:opendocument:xmlns:svg-compatible:1.0" xmlns:chart="urn:oasis:names:tc:opendocument:xmlns:chart:1.0" xmlns:dr3d="urn:oasis:names:tc:opendocument:xmlns:dr3d:1.0" xmlns:math="http://www.w3.org/1998/Math/MathML" xmlns:form="urn:oasis:names:tc:opendocument:xmlns:form:1.0" xmlns:script="urn:oasis:names:tc:opendocument:xmlns:script:1.0" xmlns:ooo="http://openoffice.org/2004/office" xmlns:ooow="http://openoffice.org/2004/writer" xmlns:oooc="http://openoffice.org/2004/calc" xmlns:dom="http://www.w3.org/2001/xml-events" xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:rpt="http://openoffice.org/2005/report" xmlns:of="urn:oasis:names:tc:opendocument:xmlns:of:1.2" xmlns:xhtml="http://www.w3.org/1999/xhtml" xmlns:grddl="http://www.w3.org/2003/g/data-view#" xmlns:tableooo="http://openoffice.org/2009/table" xmlns:drawooo="http://openoffice.org/2010/draw" xmlns:calcext="urn:org:documentfoundation:names:experimental:calc:xmlns:calcext:1.0" xmlns:loext="urn:org:documentfoundation:names:experimental:office:xmlns:loext:1.0" xmlns:field="urn:openoffice:names:experimental:ooo-ms-interop:xmlns:field:1.0" xmlns:formx="urn:openoffice:names:experimental:ooxml-odf-interop:xmlns:form:1.0" xmlns:css3t="http://www.w3.org/TR/css3-text/" office:version="1.2"><office:scripts/><office:font-face-decls><style:font-face style:name="新細明體" svg:font-family="新細明體" style:font-family-generic="roman"/><style:font-face style:name="新細明體1" svg:font-family="新細明體" style:font-family-generic="swiss"/><style:font-face style:name="Nimbus Sans L" svg:font-family="&apos;Nimbus Sans L&apos;" style:font-family-generic="swiss" style:font-pitch="variable"/><style:font-face style:name="DejaVu Sans" svg:font-family="&apos;DejaVu Sans&apos;" style:font-family-generic="system" style:font-pitch="variable"/><style:font-face style:name="Droid Sans Fallback" svg:font-family="&apos;Droid Sans Fallback&apos;" style:font-family-generic="system" style:font-pitch="variable"/></office:font-face-decls><office:automatic-styles><style:style style:name="co1" style:family="table-column"><style:table-column-properties fo:break-before="auto" style:column-width="34.7pt"/></style:style><style:style style:name="co2" style:family="table-column"><style:table-column-properties fo:break-before="auto" style:column-width="45.5pt"/></style:style><style:style style:name="co3" style:family="table-column"><style:table-column-properties fo:break-before="auto" style:column-width="68.71pt"/></style:style><style:style style:name="co4" style:family="table-column"><style:table-column-properties fo:break-before="auto" style:column-width="91.84pt"/></style:style><style:style style:name="co5" style:family="table-column"><style:table-column-properties fo:break-before="auto" style:column-width="82.54pt"/></style:style><style:style style:name="co6" style:family="table-column"><style:table-column-properties fo:break-before="auto" style:column-width="65.59pt"/></style:style><style:style style:name="co7" style:family="table-column"><style:table-column-properties fo:break-before="auto" style:column-width="94.9pt"/></style:style><style:style style:name="co8" style:family="table-column"><style:table-column-properties fo:break-before="auto" style:column-width="65.31pt"/></style:style><style:style style:name="ro1" style:family="table-row"><style:table-row-properties style:row-height="22.05pt" fo:break-before="auto" style:use-optimal-row-height="true"/></style:style><style:style style:name="ro2" style:family="table-row"><style:table-row-properties style:row-height="26.11pt" fo:break-before="auto" style:use-optimal-row-height="true"/></style:style><style:style style:name="ro3" style:family="table-row"><style:table-row-properties style:row-height="15pt" fo:break-before="auto" style:use-optimal-row-height="true"/></style:style><style:style style:name="ro4" style:family="table-row"><style:table-row-properties style:row-height="51.76pt" fo:break-before="auto" style:use-optimal-row-height="false"/></style:style><style:style style:name="ro5" style:family="table-row"><style:table-row-properties style:row-height="16.5pt" fo:break-before="auto" style:use-optimal-row-height="true"/></style:style><style:style style:name="ta1" style:family="table" style:master-page-name="PageStyle_5f_工作表1"><style:table-properties table:display="true" style:writing-mode="lr-tb"/></style:style><style:style style:name="ta2" style:family="table" style:master-page-name="PageStyle_5f_工作表2"><style:table-properties table:display="true" style:writing-mode="lr-tb"/></style:style><style:style style:name="ta3" style:family="table" style:master-page-name="PageStyle_5f_工作表3"><style:table-properties table:display="true" style:writing-mode="lr-tb"/></style:style><number:text-style style:name="N100"><number:text-content/></number:text-style><style:style style:name="ce1" style:family="table-cell" style:parent-style-name="一般_20_5" style:data-style-name="N0"><style:table-cell-properties style:diagonal-bl-tr="none" style:diagonal-tl-br="none" fo:background-color="transparent" fo:border="none" style:rotation-align="none"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="18pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="bold" style:font-size-asian="18pt" style:font-style-asian="normal" style:font-weight-asian="bold" style:font-name-complex="新細明體" style:font-size-complex="18pt" style:font-style-complex="normal" style:font-weight-complex="bold"/></style:style><style:style style:name="ce2" style:family="table-cell" style:parent-style-name="一般_20_5" style:data-style-name="N0"><style:table-cell-properties fo:background-color="#ccffcc" style:diagonal-bl-tr="none" style:diagonal-tl-br="none" style:text-align-source="value-type" style:repeat-content="false" fo:wrap-option="no-wrap" fo:border="none" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="false" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="18pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="bold" style:font-size-asian="18pt" style:font-style-asian="normal" style:font-weight-asian="bold" style:font-name-complex="新細明體" style:font-size-complex="18pt" style:font-style-complex="normal" style:font-weight-complex="bold"/></style:style><style:style style:name="ce3" style:family="table-cell" style:parent-style-name="一般_20_5"><style:table-cell-properties style:rotation-align="none"/></style:style><style:style style:name="ce4" style:family="table-cell" style:parent-style-name="一般_20_5" style:data-style-name="N100"><style:table-cell-properties fo:background-color="#ffff00" style:text-align-source="value-type" style:repeat-content="false" fo:wrap-option="no-wrap" fo:border="none" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="true" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="18pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="bold" style:font-size-asian="18pt" style:font-style-asian="normal" style:font-weight-asian="bold" style:font-name-complex="新細明體" style:font-size-complex="18pt" style:font-style-complex="normal" style:font-weight-complex="bold"/></style:style><style:style style:name="ce5" style:family="table-cell" style:parent-style-name="一般_20_5" style:data-style-name="N0"><style:table-cell-properties fo:background-color="#ccffcc" style:diagonal-bl-tr="none" style:diagonal-tl-br="none" style:text-align-source="value-type" style:repeat-content="false" fo:wrap-option="no-wrap" fo:border="none" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="true" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="18pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="bold" style:font-size-asian="18pt" style:font-style-asian="normal" style:font-weight-asian="bold" style:font-name-complex="新細明體" style:font-size-complex="18pt" style:font-style-complex="normal" style:font-weight-complex="bold"/></style:style><style:style style:name="ce6" style:family="table-cell" style:parent-style-name="一般_20_5" style:data-style-name="N100"><style:table-cell-properties fo:background-color="#ffff99" style:diagonal-bl-tr="none" style:diagonal-tl-br="none" style:text-align-source="fix" style:repeat-content="false" fo:wrap-option="no-wrap" fo:border="0.74pt solid #000000" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="false" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties fo:text-align="center" css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="14pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="bold" style:font-size-asian="14pt" style:font-style-asian="normal" style:font-weight-asian="bold" style:font-name-complex="新細明體" style:font-size-complex="14pt" style:font-style-complex="normal" style:font-weight-complex="bold"/></style:style><style:style style:name="ce7" style:family="table-cell" style:parent-style-name="一般_20_5" style:data-style-name="N125"><style:table-cell-properties fo:border-bottom="0.74pt solid #000000" fo:background-color="#ffffcc" style:diagonal-bl-tr="none" style:diagonal-tl-br="none" style:text-align-source="fix" style:repeat-content="false" fo:wrap-option="no-wrap" fo:border-left="0.74pt solid #000000" style:direction="ltr" fo:border-right="0.74pt solid #000000" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="true" fo:border-top="none" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties fo:text-align="center" css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="12pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="bold" style:font-size-asian="12pt" style:font-style-asian="normal" style:font-weight-asian="bold" style:font-name-complex="新細明體" style:font-size-complex="12pt" style:font-style-complex="normal" style:font-weight-complex="bold"/></style:style><style:style style:name="ce8" style:family="table-cell" style:parent-style-name="一般_20_5" style:data-style-name="N125"><style:table-cell-properties fo:background-color="#ffffcc" style:diagonal-bl-tr="none" style:diagonal-tl-br="none" style:text-align-source="fix" style:repeat-content="false" fo:wrap-option="no-wrap" fo:border="0.74pt solid #000000" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="true" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties fo:text-align="center" css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="12pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="bold" style:font-size-asian="12pt" style:font-style-asian="normal" style:font-weight-asian="bold" style:font-name-complex="新細明體" style:font-size-complex="12pt" style:font-style-complex="normal" style:font-weight-complex="bold"/></style:style><style:style style:name="ce9" style:family="table-cell" style:parent-style-name="一般_20_5"><style:table-cell-properties fo:background-color="#ccffcc" style:diagonal-bl-tr="none" style:diagonal-tl-br="none" style:text-align-source="value-type" style:repeat-content="false" fo:wrap-option="no-wrap" fo:border="none" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="false" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="18pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="normal" style:font-size-asian="18pt" style:font-style-asian="normal" style:font-weight-asian="normal" style:font-name-complex="新細明體" style:font-size-complex="18pt" style:font-style-complex="normal" style:font-weight-complex="normal"/></style:style><style:style style:name="ce10" style:family="table-cell" style:parent-style-name="一般_20_5"><style:table-cell-properties fo:background-color="#ffff00" style:text-align-source="value-type" style:repeat-content="false" fo:wrap-option="no-wrap" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="true" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="18pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="normal" style:font-size-asian="18pt" style:font-style-asian="normal" style:font-weight-asian="normal" style:font-name-complex="新細明體" style:font-size-complex="18pt" style:font-style-complex="normal" style:font-weight-complex="normal"/></style:style><style:style style:name="ce11" style:family="table-cell" style:parent-style-name="一般_20_5"><style:table-cell-properties style:diagonal-bl-tr="none" style:diagonal-tl-br="none" style:text-align-source="value-type" style:repeat-content="false" fo:wrap-option="no-wrap" fo:border="none" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="true" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="18pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="normal" style:font-size-asian="18pt" style:font-style-asian="normal" style:font-weight-asian="normal" style:font-name-complex="新細明體" style:font-size-complex="18pt" style:font-style-complex="normal" style:font-weight-complex="normal"/></style:style><style:style style:name="ce12" style:family="table-cell" style:parent-style-name="一般_20_5" style:data-style-name="N0"><style:table-cell-properties style:diagonal-bl-tr="none" style:diagonal-tl-br="none" style:text-align-source="fix" style:repeat-content="false" fo:wrap-option="no-wrap" fo:border="0.74pt solid #000000" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="true" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties fo:text-align="center" css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="14pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="normal" style:font-size-asian="14pt" style:font-style-asian="normal" style:font-weight-asian="normal" style:font-name-complex="新細明體" style:font-size-complex="14pt" style:font-style-complex="normal" style:font-weight-complex="normal"/></style:style><style:style style:name="ce13" style:family="table-cell" style:parent-style-name="一般_20_5" style:data-style-name="N0"><style:table-cell-properties fo:border-bottom="0.74pt solid #000000" style:diagonal-bl-tr="none" style:diagonal-tl-br="none" style:text-align-source="fix" style:repeat-content="false" fo:wrap-option="no-wrap" fo:border-left="0.74pt solid #000000" style:direction="ltr" fo:border-right="0.74pt solid #000000" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="true" fo:border-top="none" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties fo:text-align="center" css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="14pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="normal" style:font-size-asian="14pt" style:font-style-asian="normal" style:font-weight-asian="normal" style:font-name-complex="新細明體" style:font-size-complex="14pt" style:font-style-complex="normal" style:font-weight-complex="normal"/></style:style><style:style style:name="ce14" style:family="table-cell" style:parent-style-name="Default"><style:table-cell-properties fo:background-color="#ccffcc" style:text-align-source="value-type" style:repeat-content="false" fo:wrap-option="no-wrap" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="false" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/></style:style><style:style style:name="ce15" style:family="table-cell" style:parent-style-name="一般_20_5"><style:table-cell-properties fo:background-color="#ffff00" style:text-align-source="value-type" style:repeat-content="false" fo:wrap-option="no-wrap" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="true" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/></style:style><style:style style:name="ce16" style:family="table-cell" style:parent-style-name="一般_20_5"><style:table-cell-properties fo:background-color="#ccffcc" style:rotation-align="none"/></style:style><style:style style:name="ce17" style:family="table-cell" style:parent-style-name="一般_20_5"><style:table-cell-properties style:text-align-source="value-type" style:repeat-content="false" fo:wrap-option="no-wrap" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="true" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/></style:style><style:style style:name="ce18" style:family="table-cell" style:parent-style-name="一般_20_5" style:data-style-name="N100"><style:table-cell-properties style:diagonal-bl-tr="none" style:diagonal-tl-br="none" style:text-align-source="fix" style:repeat-content="false" fo:wrap-option="no-wrap" fo:border="0.74pt solid #000000" style:direction="ltr" style:rotation-angle="0" style:rotation-align="none" style:shrink-to-fit="false" style:vertical-align="middle" loext:vertical-justify="auto"/><style:paragraph-properties fo:text-align="center" css3t:text-justify="auto" fo:margin-left="0pt" style:writing-mode="page"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="14pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="normal" style:font-size-asian="14pt" style:font-style-asian="normal" style:font-weight-asian="normal" style:font-name-complex="新細明體" style:font-size-complex="14pt" style:font-style-complex="normal" style:font-weight-complex="normal"/></style:style><style:style style:name="ce19" style:family="table-cell" style:parent-style-name="一般_20_5" style:data-style-name="N100"><style:table-cell-properties style:diagonal-bl-tr="none" style:diagonal-tl-br="none" fo:border="0.74pt solid #000000" style:rotation-align="none"/><style:text-properties style:use-window-font-color="true" style:text-outline="false" style:text-line-through-style="none" style:text-line-through-type="none" style:font-name="新細明體" fo:font-size="14pt" fo:font-style="normal" fo:text-shadow="none" style:text-underline-style="none" fo:font-weight="normal" style:font-size-asian="14pt" style:font-style-asian="normal" style:font-weight-asian="normal" style:font-name-complex="新細明體" style:font-size-complex="14pt" style:font-style-complex="normal" style:font-weight-complex="normal"/></style:style></office:automatic-styles><office:body><office:spreadsheet><table:calculation-settings table:case-sensitive="false" table:automatic-find-labels="false" table:use-regular-expressions="false"><table:iteration table:maximum-difference="0.0001"/></table:calculation-settings><table:table table:name="工作表1" table:style-name="ta1"><office:forms form:automatic-focus="false" form:apply-design-mode="false"/><table:table-column table:style-name="co1" table:default-cell-style-name="Default"/><table:table-column table:style-name="co2" table:default-cell-style-name="Default"/><table:table-column table:style-name="co3" table:default-cell-style-name="Default"/><table:table-column table:style-name="co4" table:default-cell-style-name="Default"/><table:table-column table:style-name="co5" table:default-cell-style-name="Default"/><table:table-column table:style-name="co6" table:default-cell-style-name="Default"/><table:table-column table:style-name="co7" table:default-cell-style-name="Default"/><table:table-column table:style-name="co8" table:number-columns-repeated="1017" table:default-cell-style-name="Default"/><table:table-row table:style-name="ro1"><table:table-cell table:style-name="ce1" table:number-columns-repeated="3"/><table:table-cell table:style-name="ce3" table:number-columns-repeated="5"/><table:table-cell table:number-columns-repeated="1016"/></table:table-row><table:table-row table:style-name="ro2"><table:table-cell table:style-name="ce2" office:value-type="string" calcext:value-type="string"><text:p>優惠記名卡車站領卡清單(製卡端:社會局)</text:p></table:table-cell><table:table-cell table:style-name="ce9" table:number-columns-repeated="2"/><table:table-cell table:style-name="ce14"/><table:table-cell table:style-name="ce16" table:number-columns-repeated="2"/><table:table-cell table:style-name="ce3" table:number-columns-repeated="2"/><table:table-cell table:number-columns-repeated="1016"/></table:table-row><table:table-row table:style-name="ro3"><table:table-cell table:style-name="ce3" table:number-columns-repeated="8"/><table:table-cell table:number-columns-repeated="1016"/></table:table-row><table:table-row table:style-name="ro2"><table:table-cell table:style-name="ce4" office:value-type="string" calcext:value-type="string" table:number-columns-spanned="4" table:number-rows-spanned="1"><text:p>卡片配至車站日期:'

p2 = '</text:p></table:table-cell><table:covered-table-cell table:number-columns-repeated="2" table:style-name="ce10"/><table:covered-table-cell table:style-name="ce15"/><table:table-cell table:style-name="ce17"/><table:table-cell table:style-name="ce3" table:number-columns-repeated="3"/><table:table-cell table:number-columns-repeated="1016"/></table:table-row><table:table-row table:style-name="ro1"><table:table-cell table:style-name="ce5" office:value-type="string" calcext:value-type="string" table:number-columns-spanned="2" table:number-rows-spanned="1"><text:p>配送車站：'

p3 = '</text:p></table:table-cell><table:covered-table-cell table:style-name="ce11"/><table:table-cell table:style-name="ce11"/><table:table-cell table:style-name="ce3" table:number-columns-repeated="5"/><table:table-cell table:number-columns-repeated="1016"/></table:table-row><table:table-row table:style-name="ro4"><table:table-cell table:style-name="ce6" office:value-type="string" calcext:value-type="string"><text:p>項次</text:p></table:table-cell><table:table-cell table:style-name="ce6" office:value-type="string" calcext:value-type="string"><text:p>卡種</text:p></table:table-cell><table:table-cell table:style-name="ce6" office:value-type="string" calcext:value-type="string"><text:p>姓名</text:p></table:table-cell><table:table-cell table:style-name="ce6" office:value-type="string" calcext:value-type="string"><text:p>外觀卡號</text:p></table:table-cell><table:table-cell table:style-name="ce6" office:value-type="string" calcext:value-type="string"><text:p>領卡人簽收</text:p></table:table-cell><table:table-cell table:style-name="ce6" office:value-type="string" calcext:value-type="string"><text:p>發卡日期</text:p></table:table-cell><table:table-cell table:style-name="ce6" office:value-type="string" calcext:value-type="string"><text:p>車站發卡人員</text:p></table:table-cell><table:table-cell table:number-columns-repeated="1017"/></table:table-row>'

p4 = '<table:table-row table:style-name="ro6"><table:table-cell table:style-name="ce7" office:value-type="float" office:value="1" calcext:value-type="float"><text:p>'

p5 = '</text:p></table:table-cell><table:table-cell table:style-name="ce11" office:value-type="string" calcext:value-type="string"><text:p>敬老卡</text:p></table:table-cell><table:table-cell table:style-name="ce11" office:value-type="string" calcext:value-type="string"><text:p>'

p6 = '</text:p></table:table-cell><table:table-cell table:style-name="ce11" office:value-type="string" calcext:value-type="string"><text:p>'

p7 = '</text:p></table:table-cell><table:table-cell table:style-name="ce16" table:number-columns-repeated="3"/><table:table-cell table:number-columns-repeated="1017"/></table:table-row>'

p8 = '<table:table-row table:style-name="ro4" table:number-rows-repeated="1048565"><table:table-cell table:number-columns-repeated="1024"/></table:table-row><table:table-row table:style-name="ro4"><table:table-cell table:number-columns-repeated="1024"/></table:table-row></table:table><table:table table:name="工作表2" table:style-name="ta2"><table:table-column table:style-name="co8" table:number-columns-repeated="1024" table:default-cell-style-name="Default"/><table:table-row table:style-name="ro5" table:number-rows-repeated="1048575"><table:table-cell table:number-columns-repeated="1024"/></table:table-row><table:table-row table:style-name="ro5"><table:table-cell table:number-columns-repeated="1024"/></table:table-row></table:table><table:table table:name="工作表3" table:style-name="ta3"><table:table-column table:style-name="co8" table:number-columns-repeated="1024" table:default-cell-style-name="Default"/><table:table-row table:style-name="ro5" table:number-rows-repeated="1048575"><table:table-cell table:number-columns-repeated="1024"/></table:table-row><table:table-row table:style-name="ro5"><table:table-cell table:number-columns-repeated="1024"/></table:table-row></table:table><table:named-expressions/></office:spreadsheet></office:body></office:document-content>'

# Loop through stations:
dump.keys.each do |s|
  station = s.sub(' ', '')
  ## Using 7-zip in Desktop; assuming manifest.ods is placed in Desktop
  ## Decompress template ODS into temporary directory
  Dir.chdir(templatedir)
  system("../../7z.exe e -y ../../manifest.ods")
  
  ## Modify content.xml
  File.open("content.xml", "w") do |f|
    f.write(p1 + delivery_date + p2 + station + p3)
    dump[station].each.with_index(1) do |l, index| # name: l[0], number: l[1]
      f.write(p4 + index.to_s + p5 + l[0] + p6 + l[1] + p7)
    end
    f.write(p8)
    f.close
  end

  ## Create new ODS using date and station as filename
  ## e.g. 20180316_*.ods
  ## $ zip -0 -X ../document2.ods mimetype
  ## $ zip -r ../document2.ods * -x mimetype
  Dir.chdir(filedir)
  system("../7z.exe a -tzip -mx=0 -mtc=off #{station}.ods ./template/mimetype")
  system("../7z.exe a -r #{station}.ods ./template/* -x!template/mimetype")
end